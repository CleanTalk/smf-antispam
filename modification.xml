<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="www.simplemachines.org/xml/modification">
	<id>cleantalk:antispam</id>
	<version>1.20</version>
	<file name="$sourcedir/Register.php">
		<operation>
			<search position="after"><![CDATA[// Show the user the right form.]]></search>
			<add><![CDATA[if (!isset($_POST['regSubmit']))
	{
		// cleantalk set start time of registration
		$_SESSION['cleantalk_registration_form_start_time'] = time();
	}
]]>
</add>
		</operation>
	</file>

	<file name="$themedir/Register.template.php">
		<operation>
			<search position="after"><![CDATA[// Are there any custom fields?]]></search>
			<add><![CDATA[$cleantalkId = uniqid('ct_checkjs');
echo '<input type="hidden" name="ct_checkjs" id="', $cleantalkId, '" value="ok" /><script type="text/javascript">document.getElementById("', $cleantalkId, '").value ="', cleantalk_get_checkjs_code(), '";</script>';
]]>
</add>
		</operation>
	</file>

    <file name="$sourcedir/Post.php">
        <operation>
            <search position="after"><![CDATA[createPost($msgOptions, $topicOptions, $posterOptions);]]></search>
            <add><![CDATA[cleantalk_check_message($msgOptions, $topicOptions, $posterOptions);]]>
            </add>
        </operation>
        <operation>
            <search position="after"><![CDATA[// Finally, load the template.]]></search>
            <add><![CDATA[/*For CleanTalk form submit time*/ if ($context['current_action'] == 'post'){ $_SESSION['cleantalk_post_form_start_time'][$context['form_sequence_number']] = time();}]]>
</add>
        </operation>
    </file>

    <file name="$themedir/Post.template.php">
        <operation>
            <search position="after"><![CDATA[// Finally, the submit buttons.]]></search>
            <add><![CDATA[$cleantalkId = uniqid('ct_checkjs');
    echo '<input type="hidden" name="ct_checkjs" id="', $cleantalkId, '" value="ok" /><script type="text/javascript">document.getElementById("', $cleantalkId, '").value ="', cleantalk_get_checkjs_code(), '";</script>';]]>
</add>
        </operation>
    </file>

</modification>